# –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

## üõ°Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞

### 1. Rate Limiting (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤)

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `slowapi` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π:

#### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤):

- **100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å** —Å –æ–¥–Ω–æ–≥–æ IP
- **20 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É** —Å –æ–¥–Ω–æ–≥–æ IP

#### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–µ–º–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

- **POST /detect** - 1 –∑–∞–ø—Ä–æ—Å –≤ –º–∏–Ω—É—Ç—É (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
- **POST /video/analyze** - 1 –∑–∞–ø—Ä–æ—Å –≤ –º–∏–Ω—É—Ç—É (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ)

#### –õ–∏–º–∏—Ç—ã –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:

- **GET /** - 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- **GET /health** - 60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

### 2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤

- **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: –º–∞–∫—Å–∏–º—É–º 5 –ú–ë
- **–í–∏–¥–µ–æ**: –º–∞–∫—Å–∏–º—É–º 200 –ú–ë
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ**: –º–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

## üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Nginx –∫–∞–∫ reverse proxy

–î–æ–±–∞–≤—å—Ç–µ Nginx –ø–µ—Ä–µ–¥ FastAPI –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã:

```nginx
# /etc/nginx/sites-available/cowcount

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –æ–¥–Ω–æ–≥–æ IP
limit_conn_zone $binary_remote_addr zone=addr:10m;
limit_conn addr 10;

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

server {
    listen 80;
    server_name your-domain.com;

    # –ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ–ª—å—à–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
    client_max_body_size 200M;

    # –¢–∞–π–º–∞—É—Ç—ã
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;

    location / {
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ rate limiting
        limit_req zone=api burst=20 nodelay;

        # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ FastAPI
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ)
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Cloudflare

Cloudflare –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç DDoS:

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –¥–æ–º–µ–Ω –Ω–∞ Cloudflare
2. –í–∫–ª—é—á–∏—Ç–µ "Under Attack Mode" –ø—Ä–∏ –∞—Ç–∞–∫–µ
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ WAF (Web Application Firewall) –ø—Ä–∞–≤–∏–ª–∞
4. –í–∫–ª—é—á–∏—Ç–µ "Rate Limiting" –Ω–∞ —É—Ä–æ–≤–Ω–µ Cloudflare

### 3. Fail2Ban –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Fail2Ban –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö IP:

```bash
sudo apt-get install fail2ban
```

–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è FastAPI:

```ini
# /etc/fail2ban/jail.local
[fastapi-ratelimit]
enabled = true
port = http,https
filter = fastapi-ratelimit
logpath = /var/log/fastapi/access.log
maxretry = 5
bantime = 3600
findtime = 600
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- **Prometheus + Grafana** - –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–µ—Ç—Ä–∏–∫
- **Sentry** - –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- **ELK Stack** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤

### 5. HTTPS –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Let's Encrypt –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:

```bash
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 6. Firewall (UFW)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ firewall –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞:

```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 7. Docker —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker, –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã:

```yaml
# docker-compose.yml
services:
  ml-service:
    image: cowcount-ml
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          cpus: "1"
          memory: 2G
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞—Ç–∞–∫

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:

```bash
# –¢–æ–ø IP –∞–¥—Ä–µ—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤
tail -n 10000 /var/log/nginx/access.log | awk '{print $1}' | sort | uniq -c | sort -rn | head -20

# –ü–æ–∏—Å–∫ 429 –æ—à–∏–±–æ–∫ (rate limit exceeded)
grep "429" /var/log/nginx/access.log | tail -50
```

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ IP –≤—Ä—É—á–Ω—É—é:

```bash
# –ß–µ—Ä–µ–∑ iptables
sudo iptables -A INPUT -s EGORS_IP_ADDRESS -j DROP

# –ß–µ—Ä–µ–∑ UFW
sudo ufw deny from EGORS_IP_ADDRESS
```

## üîí –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- [x] Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (slowapi)
- [x] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] Nginx reverse proxy —Å rate limiting
- [ ] HTTPS —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
- [ ] Cloudflare DDoS protection
- [ ] Fail2Ban –¥–ª—è –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- [ ] Firewall (UFW/iptables)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üÜò –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –∞—Ç–∞–∫–µ

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –í–∫–ª—é—á–∏—Ç–µ "Under Attack Mode" –≤ Cloudflare
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**: –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ IP –∞–¥—Ä–µ—Å–∞ –∞—Ç–∞–∫—É—é—â–∏—Ö
3. **–ó–∞–±–ª–æ–∫–∏—Ä—É–π—Ç–µ IP**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ iptables –∏–ª–∏ UFW
4. **–£–º–µ–Ω—å—à–∏—Ç–µ –ª–∏–º–∏—Ç—ã**: –í—Ä–µ–º–µ–Ω–Ω–æ —Å–Ω–∏–∑—å—Ç–µ rate limits
5. **–°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ö–æ—Å—Ç–∏–Ω–≥–æ–º**: –û–Ω–∏ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å —Å –∑–∞—â–∏—Ç–æ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ç–∏

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏

- Cloudflare Support: https://support.cloudflare.com
- –í–∞—à —Ö–æ—Å—Ç–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- Telegram: @your_admin_contact

---

**–ü–æ–º–Ω–∏—Ç–µ**: –õ—É—á—à–∞—è –∑–∞—â–∏—Ç–∞ - —ç—Ç–æ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞! üõ°Ô∏è
